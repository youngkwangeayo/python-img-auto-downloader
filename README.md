# 이미지 자동 저장 프로그램

FRANCHISEE 테이블에서 로고 이미지 URL을 조회하여 S3에서 이미지를 다운로드하고, 지정된 규칙에 따라 파일명을 생성하여 로컬에 저장하는 자동화 프로그램입니다.

## 주요 기능

- MySQL 데이터베이스에서 프랜차이즈 정보 조회
- S3 이미지 자동 다운로드
- 규칙 기반 파일명 생성 (`FR_ID_FR_NM_랜덤4자리.확장자`)
- 1000건 단위 배치 처리로 DB 부담 최소화
- SSH 터널을 통한 안전한 DB 연결 지원
- 상세한 로깅 및 진행 상황 추적

## 설치 방법

### 1. 저장소 클론 또는 파일 다운로드

```bash
cd /path/to/auto-img-save
```

### 2. Python 가상환경 생성 및 활성화

```bash
python3 -m venv venv
source venv/bin/activate
```

### 3. 필요한 라이브러리 설치

```bash
pip install -r requirements.txt
```

## 설정

### config.json 파일 구조

`config.json` 파일이 이미 생성되어 있습니다. 필요에 따라 설정을 수정하세요.

```json
{
  "database": {
    "host": "데이터베이스 호스트",
    "port": 3306,
    "user": "사용자명",
    "password": "비밀번호",
    "database": "데이터베이스명"
  },
  "ssh_tunnel": {
    "enabled": false,
    "ssh_host": "점프호스트 IP",
    "ssh_user": "ec2-user",
    "ssh_key_path": "SSH 키 경로",
    "remote_bind_address": "데이터베이스 호스트",
    "remote_bind_port": 3306
  },
  "s3_base_url": "https://your-s3-domain.com/",
  "batch_size": 1000,
  "output_directory": "./downloaded_images",
  "log_file": "./download_log.txt"
}
```

### SSH 터널 사용 방법

직접 데이터베이스 연결이 안 될 경우, SSH 터널을 활성화하세요:

```json
"ssh_tunnel": {
  "enabled": true,
  ...
}
```

## 실행 방법

### 기본 실행

```bash
python main.py
```

## 파일 구조

```
auto-img-save/
├── main.py                 # 메인 실행 스크립트
├── config.json            # 설정 파일 (DB 정보, S3 URL 등)
├── requirements.txt       # Python 패키지 목록
├── README.md             # 사용 설명서
├── download_log.txt      # 실행 로그 (자동 생성)
└── downloaded_images/    # 다운로드된 이미지 디렉토리 (자동 생성)
```

## 프로그램 동작 방식

1. **전체 건수 조회**: COUNT 쿼리로 처리할 전체 데이터 건수 확인
2. **배치 처리**: 1000건씩 나눠서 반복 처리
3. **이미지 다운로드**: S3 URL에서 이미지 다운로드
4. **파일명 생성**: `FR_ID_FR_NM_랜덤4자리.확장자` 형식으로 생성
5. **중복 처리**: 같은 파일명이 있으면 랜덤 4자리 변경
6. **저장**: `downloaded_images` 디렉토리에 저장
7. **로깅**: 성공/실패 건수 및 상세 로그 기록

## 로그 확인

프로그램 실행 중 및 완료 후 로그는 다음 위치에서 확인할 수 있습니다:

- **콘솔 출력**: 실시간 진행 상황
- **download_log.txt**: 전체 실행 로그 파일

### 로그 예시

```
[2025-12-16 10:30:00] [INFO] ================================================================================
[2025-12-16 10:30:00] [INFO] 이미지 다운로드 프로그램 시작
[2025-12-16 10:30:00] [INFO] ================================================================================
[2025-12-16 10:30:01] [INFO] 직접 데이터베이스 연결 시도...
[2025-12-16 10:30:02] [INFO] 데이터베이스 직접 연결 성공
[2025-12-16 10:30:02] [INFO] 전체 대상 건수: 2500
[2025-12-16 10:30:02] [INFO] 총 배치 수: 3 (배치 크기: 1000)
[2025-12-16 10:30:02] [INFO] 배치 1/3 처리 시작 (offset: 0, limit: 1000)
...
```

## 결과 리포트

프로그램 완료 후 다음 정보가 제공됩니다:

- 전체 대상 건수
- 총 배치 수
- 배치별 성공/실패 건수
- 전체 성공/실패 건수
- 실행 시간
- 실패한 FR_ID 목록

## 문제 해결

### 데이터베이스 연결 실패

1. **직접 연결 실패 시**: `config.json`에서 `ssh_tunnel.enabled`를 `true`로 변경
2. **SSH 키 권한 오류**:
   ```bash
   chmod 600 /path/to/your-ssh-key.pem
   ```

### 이미지 다운로드 실패

- 네트워크 연결 확인
- S3 URL 접근 가능 여부 확인
- 로그 파일에서 실패 원인 확인

### 디스크 공간 부족

- `downloaded_images` 디렉토리 용량 확인
- 불필요한 파일 삭제 후 재실행

## 주의사항

- 프로그램 실행 중 중단하려면 `Ctrl+C`를 누르세요.
- 대용량 처리 시 충분한 디스크 공간을 확보하세요.
- SSH 키 파일의 권한을 적절히 설정하세요 (`chmod 600`).
- DB 연결 정보를 외부에 노출하지 마세요.

## 기술 스택

- **Python 3.x**
- **PyMySQL**: MySQL 데이터베이스 연결
- **Requests**: HTTP 요청으로 이미지 다운로드
- **SSHTunnel**: SSH 터널링을 통한 안전한 DB 연결

## 라이센스

내부 사용 전용
